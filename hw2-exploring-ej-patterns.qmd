---
title: "HW2: Exploring Patterns of Environmental Justice"
format: html
message: false
warning: false
---

```{r}
# Load needed libraries 
library(tidyverse)
library(sf) # For handling vector data
library(tmap) # For making maps
library(spData) # Pre-loaded spatial data
library(kableExtra)
```

#### Read in data
```{r}
# Read in environmental justice data
ejscreen <- st_read(here::here("data", "ejscreen", "EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb"))

# Read in redlining data
redlining <- st_read(here::here("data", "mapping-inequality", "mapping-inequality-los-angeles.json"))

# Read in biodiversity data
bio_div <- st_read(here::here("data", "gbif-birds-LA", "gbif-birds-LA.shp"))
```
Select for Los Angeles County data. This reduces the amount of processing time for future joins and mapping.
```{r}
 la_ejscreen <- ejscreen |> 
  filter(CNTY_NAME == "Los Angeles County")
```

Looking at the CRS for all of the datasets: 
```{r}
# EJ screen CRS
st_crs(la_ejscreen)
```


```{r}
# Redlining CRS
st_crs(redlining)
```


```{r}
# Biodiversity CRS
st_crs(bio_div)
```

 Check to see if the projections are geographic or projected.
```{r}
st_crs(la_ejscreen)$IsGeographic
st_crs(redlining)$IsGeographic
st_crs(bio_div)$IsGeographic
```
 
Since the environmental justice data is projected, and projected coordinate reference systems are better for 2D map making this is the CRS that will be used for this mapping assignment. Change the CRS of redlining data and biodiversity data to match the CRS of the environmental justice screen data.  
```{r}
# Use st_transform() to set the CRS to that of the environmental justice data
redlining <- st_transform(redlining, crs = st_crs(la_ejscreen))
bio_div <- st_transform(bio_div, crs = st_crs(la_ejscreen))
```

#### Making sure the CRS are the same for all of the datasets
```{r}
# Setting the CRS to equal each other in a boolean to make sure they are all the same
# Check relining data is using the same CRS as la_ejscreen data
if (st_crs(la_ejscreen)==st_crs(redlining)){
  print("it's a match!")
}else {
    print("still not a match")
}

# Check bio diversity data is using the same CRS as la_ejscreen data
if (st_crs(la_ejscreen)==st_crs(bio_div)){
  print("it's a match!")
}else {
    print("still not a match")
  }
```


# Part 1: Legacy of Redlining in current environmental (in)justice
### 1. Create a map of historical relining neighborhoods 
```{r}
tm_shape(la_ejscreen) +
  tm_polygons() + 
tm_shape(redlining, is.main = TRUE) + # is.main to make this the size of the map
  tm_polygons(fill = "grade",
              fill.scale = tm_scale_discrete(values = c("#9ca260", "#98aeac", "#d7b65d", "#cb6e7e")), # Color matched to align with historical maps 
              fill.legend = tm_legend(title = "Ranked Redlining by the HOLC",
                                      labels = c("A", "B", "C", "D", "NA"))) + # Add the label 
  tm_title(text = "Los Angeles Historic Home Owners' Loan Corporation (HOLC) Redlining",
           frame = TRUE) + 
  tm_compass() +
  tm_scalebar()
```
### 2. Create a table summarizing census block groups that fall within each HOLC grade 

Combine the redlining data and la_ejscreen data
```{r}
# Joining redlining and la_ejscreen using the geographic data
ej_redlining <- st_join(la_ejscreen, redlining, join = st_within)

# Drop the geogrphic data since we are only creating a table
ej_redlining <- st_drop_geometry(ej_redlining)
```

```{r}
# Clean the names of the new dataframe
ej_redlining <- janitor::clean_names(ej_redlining)
```


```{r}
# Calculate percentage of census block groups that fall within each HOLC grade
perc_cen_block <- ej_redlining |> 
  group_by(grade) |> 
  summarise(grade_cnt = n()) |> 
  mutate(grade_freq = (grade_cnt/sum(grade_cnt)))

kable(perc_cen_block, 
      col.names = c("Grade", "Count", "Frequency"),
      format = "simple",
      padding = 3)
```
### 3. Create two visualizations summarizing current conditions (from the EJScreen data) within HOLC grades using the mean of percentile low life expectancy and percentile for Particulate Matter 2.5 variables.

#### Graph average percentile low life expectancy per HOLC grade area
```{r}
ej_redlining |> 
  group_by(grade) |> 
  summarise(mean_perce_low_lifeexppct = mean(lifeexppct, na.rm = TRUE)) |> 
  ungroup() |> 
  ggplot(aes(x = grade, y = mean_perce_low_lifeexppct)) +
  geom_col(aes(fill = grade)) + # geom_col allows for both an x and y for aesthetics
  labs(title = "Average Percent of Low Life Expectancy in HOLC Grade Areas",
       x = "HOLC Grade",
       y = "Average Percent of Low Life Expectancy") +
  scale_fill_manual(values = c("#9ca260", "#98aeac", "#d7b65d", "#cb6e7e")) + # Match colors to historic maps
  theme_minimal()
```


#### Graph average percent particulate matter 2.5 per HOLC grade area
```{r}
# Calculate mean of percent of Particulate Matter 2.5 (PM 2.5) in HOLC Grade Areas
ej_redlining |> 
  group_by(grade) |> # Group by grade 
 summarise(mean_perce_pm25 = mean(p_pm25, na.rm = TRUE)) |>  # Calculate mean pm2.5
  ungroup() |> 
ggplot(aes(x = grade, y = mean_perce_pm25)) +
  geom_col(aes(fill = grade)) + # geom_col allows for both an x and y for aesthetics
  labs(title = "Average Percentile for Particulate Matter 2.5 (PM 2.5) in HOLC Grade Areas",
       x = "HOLC Grade",
       y = "Average Percentile for PM 2.5") +
  scale_fill_manual(values = c("#9ca260", "#98aeac", "#d7b65d", "#cb6e7e")) + # Match colors to historic maps
  theme_minimal()
```

#### Graph Analysis

Both the average percent of low life expectancy and average percentile of Particulate Matter 2.5 per HOLC grade area show that those areas historically less likely to acquire loans from HOLC have present day adverse effects. Percent of low life expectancy clearly increases the worse the grade they were given by the HOLC. In other words, in those areas where HOLC blocked communities from acquiring mortgages, today they are areas associated with mean higher rates of percent low life expectancy and higher rates of average high Particulate Matter 2.5.

# Part 2: Legacy of redlining in biodiversity observations
### Create a visualization of the percent of observations within redlined neighborhoods within each HOLC grade

Combine the redlining data and bird observation data
```{r}
# Joining redlining and  using the geographic data
bio_redlining <- st_join(bio_div, redlining, join = st_intersects)

# Drop the geogrphic data since we are only making a graph
bio_redlining <- st_drop_geometry(bio_redlining)
```

```{r}
# Calculate the number of observations in each grade 
bio_redlining |> 
  group_by(grade) |> 
  summarise(observation_cnt = n()) |>
  ungroup() |> 
  mutate(observation_freq = observation_cnt/sum(observation_cnt, na.rm = TRUE)) |>
  drop_na() |> 
  ggplot(aes(x = grade, y = observation_freq)) + 
  geom_col(aes(fill = grade)) +
  labs(title = "Percent of Bird Observations per HOLC Grade",
       x = "HOLC Grade",
       y = "Percent of Bird Observations") +
  scale_fill_manual(values = c("#9ca260", "#98aeac", "#d7b65d", "#cb6e7e")) + # Match colors to historic maps
  theme_minimal()
```

### Reason our findings dont match Ellis-Soto et al. 2023
Ellis-Soto et al. (2023) uses log to normalize the data. Los Angeles has grown since the HOLC maps were utilized much of present day Los Angeles did not exist. 
